{% extends "navbar.html" %}
{% block title %}Explore Ideas{% endblock %}

{% block content %}
<section class="py-8 bg-gray-100">
  <div class="container mx-auto max-w-2xl">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Explore Ideas</h1>

    <!-- Search Bar -->
    <form method="GET" action="" class="mb-6 flex items-center bg-white p-2 rounded-lg shadow">
      <input type="text" id="search-input" name="q" placeholder="Search ideas..." class="w-full p-2 outline-none">
    </form>

    <!-- Ideas List -->
    <div id="ideas-list">
      {% for idea in ideas %}
      <div class="bg-white rounded-lg shadow mb-6 idea-item">

        <!-- Post Header -->
        <div class="flex items-center p-4 border-b border-gray-200">
          <a href="{% url 'view_profile' idea.user.username %}" class="flex items-center">
            {% if idea.user.user_profile.profile_picture %}
            <img src="{{ idea.user.user_profile.profile_picture.url }}" class="w-10 h-10 rounded-full mr-3">
            {% else %}
            <img src="https://via.placeholder.com/40" class="w-10 h-10 rounded-full mr-3">
            {% endif %}
            <div>
              <h2 class="font-semibold text-gray-800 hover:underline">{{ idea.user.username }}</h2>
              <p class="text-xs text-gray-500">{{ idea.created_at|date:"M d, Y H:i" }}</p>
            </div>
          </a>
        </div>

        <!-- Post Content -->
        <div class="p-4">
          <h3 class="text-xl font-bold text-gray-700 mb-2">{{ idea.idea_name }}</h3>
          <p class="text-gray-700">
            {{ idea.description|truncatewords:20 }}
            <a href="{% url 'idea_detail' idea.id %}" class="text-blue-600">Read More</a>
          </p>
        </div>

        <!-- Action Buttons -->
        <div class="p-4 flex items-center justify-between border-t border-gray-200">

          <!-- Like Button -->
          <form action="{% if idea.user_liked %}{% url 'unlike_idea' idea.id %}{% else %}{% url 'like_idea' idea.id %}{% endif %}"
            method="post" class="like-form flex items-center space-x-2" data-liked="{{ idea.user_liked|yesno:'true,false' }}">
            {% csrf_token %}
            <button type="button" onclick="toggleLike(this)" class="group relative">
              <svg xmlns="http://www.w3.org/2000/svg" fill="{% if idea.user_liked %}#facc15{% else %}none{% endif %}"
                viewBox="0 0 24 24" stroke="{% if idea.user_liked %}#facc15{% else %}#9ca3af{% endif %}"
                stroke-width="1.5" class="w-8 h-8 transition duration-300 bulb-icon {% if idea.user_liked %}glow{% endif %}">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M9.75 17h4.5m-4.5 3h4.5M12 2.25c-3.75 0-6 2.672-6 5.25 0 2.154 1.156 3.362 2.003 4.165.373.35.697.653.908.975.212.322.339.698.339 1.11v.25a.75.75 0 0 0 .75.75h3.5a.75.75 0 0 0 .75-.75v-.25c0-.412.127-.788.339-1.11.21-.322.535-.624.908-.975C16.844 10.862 18 9.654 18 7.5c0-2.578-2.25-5.25-6-5.25z" />
              </svg>
            </button>
            <span class="text-gray-700 font-medium like-count">{{ idea.likes_count }}</span>
          </form>

          <!-- Comment -->
          <a href="{% url 'comment_idea' idea.id %}" class="text-blue-600 hover:text-blue-800">ðŸ’¬ Comment</a>

          <!-- Report -->
          <form action="{% url 'report_idea' idea.id %}" method="post" class="flex items-center">
            {% csrf_token %}
            <button type="submit" class="text-red-600 hover:text-red-800">ðŸš¨ Report</button>
          </form>
        </div>
      </div>
      {% empty %}
      <p class="text-gray-600">No ideas found.</p>
      {% endfor %}
    </div>
  </div>
</section>

<!-- Style and Animation -->
<style>
  .bulb-icon.glow {
    filter: drop-shadow(0 0 6px #facc15);
  }

  .bulb-icon.pop {
    animation: pop-bulb 0.3s ease;
  }

  @keyframes pop-bulb {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); }
    100% { transform: scale(1); }
  }
</style>

<!-- Like Button Handler -->
<script>
  function toggleLike(button) {
    const form = button.closest('.like-form');
    const bulb = form.querySelector('.bulb-icon');
    const countSpan = form.querySelector('.like-count');
    const liked = form.getAttribute('data-liked') === 'true';

    bulb.classList.add('pop');

    if (liked) {
      bulb.setAttribute("fill", "none");
      bulb.setAttribute("stroke", "#9ca3af");
      bulb.classList.remove("glow");
      countSpan.textContent = parseInt(countSpan.textContent) - 1;
    } else {
      bulb.setAttribute("fill", "#facc15");
      bulb.setAttribute("stroke", "#facc15");
      bulb.classList.add("glow");
      countSpan.textContent = parseInt(countSpan.textContent) + 1;
    }

    form.setAttribute('data-liked', (!liked).toString());

    setTimeout(() => {
      form.submit();
    }, 200);
  }

  document.getElementById("search-input").addEventListener("input", function () {
    let query = this.value;
    fetch("{% url 'search_ideas' %}?q=" + query)
      .then(response => response.text())
      .then(data => {
        document.getElementById("ideas-list").innerHTML = data;
      });
  });
</script>
{% endblock %}
